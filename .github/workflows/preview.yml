name: Preview - PR Build

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    pr-preview:
        runs-on: ubuntu-latest
        if: github.event.pull_request.head.repo.full_name == github.repository

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test -- --watch=false --browsers=ChromeHeadless

            - name: Build for production
              run: npm run build:production

            - name: Comment PR with build status
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      // Get build info
                      const distPath = path.join(process.env.GITHUB_WORKSPACE, 'dist');
                      const buildExists = fs.existsSync(distPath);

                      const comment = `## ðŸš€ Preview Build Status

                      âœ… Build completed successfully!

                      **PR**: #${{ github.event.pull_request.number }}
                      **Branch**: \`${{ github.head_ref }}\`
                      **Commit**: ${{ github.event.pull_request.head.sha }}

                      ### Build Details
                      - âœ… Dependencies installed
                      - âœ… Tests passed
                      - âœ… Production build completed

                      <details>
                      <summary>ðŸ“¦ Build artifacts ready for deployment</summary>

                      The production build is ready and can be deployed to a preview environment.
                      Build artifacts are available in the workflow run.

                      </details>

                      ---
                      *This comment is automatically generated by the Preview workflow.*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });

            - name: Upload preview build
              uses: actions/upload-artifact@v4
              with:
                  name: pr-${{ github.event.pull_request.number }}-preview
                  path: dist/
                  retention-days: 5
